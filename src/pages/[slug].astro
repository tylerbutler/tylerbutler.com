---
import { getCollection } from "astro:content";
import ArticlePage from "../components/ArticlePage.astro";
import {
  getArticleSlug,
  getArticleUrl,
  validateArticleSlugs,
} from "../lib/article-utils";

export async function getStaticPaths() {
  const articles = await getCollection("articles", ({ data }) => {
    return !data.draft;
  });

  // Validate no slug conflicts with reserved pages
  validateArticleSlugs(articles);

  // Sort articles by date (newest first)
  const sortedArticles = articles.sort(
    (a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime(),
  );

  return sortedArticles.map((article, index) => {
    // Get previous (older) and next (newer) articles
    const prevArticle = sortedArticles[index + 1] || null;
    const nextArticle = sortedArticles[index - 1] || null;

    return {
      params: {
        slug: getArticleSlug(article),
      },
      props: {
        article,
        prevArticle,
        nextArticle,
      },
    };
  });
}

const { article, prevArticle, nextArticle } = Astro.props;
const prevUrl = prevArticle ? getArticleUrl(prevArticle) : null;
const nextUrl = nextArticle ? getArticleUrl(nextArticle) : null;
---

<ArticlePage
  article={article}
  prevArticle={prevArticle}
  nextArticle={nextArticle}
  prevUrl={prevUrl}
  nextUrl={nextUrl}
/>
