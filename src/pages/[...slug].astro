---
import { getCollection } from "astro:content";
import ArticlePage from "../components/ArticlePage.astro";
import { getArticleUrl } from "../lib/article-utils";

export async function getStaticPaths() {
  const articles = await getCollection("articles", ({ data }) => {
    return !data.draft;
  });

  // Sort articles by date (newest first)
  const sortedArticles = articles.sort(
    (a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime(),
  );

  return sortedArticles.map((article, index) => {
    const date = new Date(article.data.date);
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, "0");
    const slug = article.data.slug || article.slug;

    // Get previous (older) and next (newer) articles
    const prevArticle = sortedArticles[index + 1] || null;
    const nextArticle = sortedArticles[index - 1] || null;

    return {
      params: {
        slug: `${year}/${month}/${slug}`,
      },
      props: {
        article,
        prevArticle,
        nextArticle,
      },
    };
  });
}

// Helper function to generate article URL for date-based routes
function generateArticleUrl(article: Parameters<typeof getArticleUrl>[0]) {
  const date = new Date(article.data.date);
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, "0");
  const slug = article.data.slug || article.slug;
  return `/${year}/${month}/${slug}`;
}

const { article, prevArticle, nextArticle } = Astro.props;
const prevUrl = prevArticle ? generateArticleUrl(prevArticle) : null;
const nextUrl = nextArticle ? generateArticleUrl(nextArticle) : null;
const canonicalUrl = `https://tylerbutler.com${getArticleUrl(article)}`;
---

<ArticlePage
  article={article}
  prevArticle={prevArticle}
  nextArticle={nextArticle}
  prevUrl={prevUrl}
  nextUrl={nextUrl}
  canonicalUrl={canonicalUrl}
/>
